# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

pool: server

steps:
- task: InvokeRESTAPI@1
  inputs:
    connectionType: 'connectedServiceName'
    serviceConnection: 'jwl50038'
    method: 'POST'
    headers: |
      {
      "Content-Type":"application/json", 
      "Authorization": "Api-token $(dynatraceApiToken)"
      }
    body: |
      {
            "eventType" : "CUSTOM_DEPLOYMENT",
            "attachRules" : {
              "tagRule" : [{
                  "meTypes" : ["SERVICE"],
                  "tags" : [ {
                    "context" : "CONTEXTLESS",
                    "key" : "app",
                    "value" : "carts"            
                  }, {
                    "context" : "CONTEXTLESS",
                    "key" : "environment",
                    "value" : "staging" 
                  }
                  ]
                }]
            },
            "source" : "Ansible Tower",
            "deploymentName" : "docker-swarm-deploy",
            "deploymentVersion" : "1.9.0-RELEASE-27",
            "deploymentProject" : "docker-swarm",
            "ciBackLink" : "https://xx.xxx.xxx.xx/#/jobs/project/1",
            "customProperties": {
              "service": "oceannow",
              "image" : "artifactory.xis.ocean.com/prod/oceannow:1.9.0-RELEASE-27",
              "tag" : "1.9.0-RELEASE-27",
              "environment" : "XIS"
            }
          }
    urlSuffix: 'api/v1/events'
    waitForCompletion: 'false'

